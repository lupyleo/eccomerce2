generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Auth
// ============================================

enum UserRole {
  CUSTOMER
  ADMIN
}

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique
  name          String?
  emailVerified DateTime? @map("email_verified")
  image         String?
  passwordHash  String?   @map("password_hash")
  role          UserRole  @default(CUSTOMER)
  phone         String?
  profileImage  String?   @map("profile_image")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  addresses    Address[]
  orders       Order[]
  reviews      Review[]
  wishlists    Wishlist[]
  cart         Cart?
  couponUsages CouponUsage[]
  accounts     Account[]
  sessions     Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Address {
  id        String  @id @default(uuid()) @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  name      String
  phone     String
  zipCode   String  @map("zip_code")
  address1  String
  address2  String?
  isDefault Boolean @default(false) @map("is_default")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

// ============================================
// Product Catalog
// ============================================

model Category {
  id        String     @id @default(uuid()) @db.Uuid
  name      String
  slug      String     @unique
  parentId  String?    @map("parent_id") @db.Uuid
  depth     Int        @default(0)
  sortOrder Int        @default(0) @map("sort_order")
  isActive  Boolean    @default(true) @map("is_active")

  parent     Category?    @relation("CategoryTree", fields: [parentId], references: [id])
  children   Category[]   @relation("CategoryTree")
  products   Product[]
  promotions Promotion[]

  @@map("categories")
}

model Brand {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  slug        String  @unique
  logoUrl     String? @map("logo_url")
  description String? @db.Text
  isActive    Boolean @default(true) @map("is_active")

  products Product[]

  @@map("brands")
}

enum ProductStatus {
  ACTIVE
  SOLD_OUT
  HIDDEN
  DISCONTINUED
}

model Product {
  id          String        @id @default(uuid()) @db.Uuid
  name        String
  slug        String        @unique
  description String        @db.Text
  basePrice   Decimal       @map("base_price") @db.Decimal(10, 2)
  categoryId  String        @map("category_id") @db.Uuid
  brandId     String?       @map("brand_id") @db.Uuid
  status      ProductStatus @default(ACTIVE)
  avgRating   Decimal       @default(0) @map("avg_rating") @db.Decimal(2, 1)
  reviewCount Int           @default(0) @map("review_count")
  salesCount  Int           @default(0) @map("sales_count")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  category  Category         @relation(fields: [categoryId], references: [id])
  brand     Brand?           @relation(fields: [brandId], references: [id])
  variants  ProductVariant[]
  images    ProductImage[]
  reviews   Review[]
  wishlists Wishlist[]

  @@index([categoryId])
  @@index([brandId])
  @@index([status])
  @@index([salesCount(sort: Desc)])
  @@map("products")
}

model ProductVariant {
  id            String  @id @default(uuid()) @db.Uuid
  productId     String  @map("product_id") @db.Uuid
  sku           String  @unique
  size          String
  color         String
  colorCode     String? @map("color_code")
  price         Decimal @db.Decimal(10, 2)
  stock         Int     @default(0)
  reservedStock Int     @default(0) @map("reserved_stock")
  isActive      Boolean @default(true) @map("is_active")

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  orderItems OrderItem[]
  stockLogs  StockLog[]

  @@unique([productId, size, color])
  @@index([productId])
  @@map("product_variants")
}

model ProductImage {
  id        String  @id @default(uuid()) @db.Uuid
  productId String  @map("product_id") @db.Uuid
  url       String
  alt       String?
  sortOrder Int     @default(0) @map("sort_order")
  isPrimary Boolean @default(false) @map("is_primary")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// ============================================
// Cart
// ============================================

model Cart {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @unique @map("user_id") @db.Uuid
  sessionId String?  @unique @map("session_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String @id @default(uuid()) @db.Uuid
  cartId    String @map("cart_id") @db.Uuid
  variantId String @map("variant_id") @db.Uuid
  quantity  Int

  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId])
  @@map("cart_items")
}

// ============================================
// Order
// ============================================

enum OrderStatus {
  PENDING
  PAID
  PREPARING
  SHIPPING
  DELIVERED
  CONFIRMED
  CANCELLED
}

model Order {
  id              String      @id @default(uuid()) @db.Uuid
  orderNumber     String      @unique @map("order_number")
  userId          String      @map("user_id") @db.Uuid
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @map("total_amount") @db.Decimal(10, 2)
  discountAmount  Decimal     @default(0) @map("discount_amount") @db.Decimal(10, 2)
  shippingFee     Decimal     @default(0) @map("shipping_fee") @db.Decimal(10, 2)
  finalAmount     Decimal     @map("final_amount") @db.Decimal(10, 2)
  addressSnapshot Json        @map("address_snapshot")
  couponId        String?     @map("coupon_id") @db.Uuid
  note            String?     @db.Text
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  user     User        @relation(fields: [userId], references: [id])
  coupon   Coupon?     @relation(fields: [couponId], references: [id])
  items    OrderItem[]
  payment  Payment?
  shipment Shipment?
  returns  Return[]
  reviews  Review[]

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id          String  @id @default(uuid()) @db.Uuid
  orderId     String  @map("order_id") @db.Uuid
  variantId   String  @map("variant_id") @db.Uuid
  productName String  @map("product_name")
  variantInfo String  @map("variant_info")
  price       Decimal @db.Decimal(10, 2)
  quantity    Int
  subtotal    Decimal @db.Decimal(10, 2)

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id])
  returns Return[]

  @@map("order_items")
}

// ============================================
// Payment
// ============================================

enum PaymentMethod {
  CARD
  VIRTUAL_ACCOUNT
  EASY_PAY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  PARTIALLY_CANCELLED
}

model Payment {
  id              String        @id @default(uuid()) @db.Uuid
  orderId         String        @unique @map("order_id") @db.Uuid
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Decimal       @db.Decimal(10, 2)
  cancelledAmount Decimal       @default(0) @map("cancelled_amount") @db.Decimal(10, 2)
  pgProvider      String        @map("pg_provider")
  pgPaymentId     String?       @map("pg_payment_id")
  pgResponse      Json?         @map("pg_response")
  paidAt          DateTime?     @map("paid_at")
  cancelledAt     DateTime?     @map("cancelled_at")
  createdAt       DateTime      @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id])

  @@index([pgPaymentId])
  @@map("payments")
}

// ============================================
// Inventory
// ============================================

enum StockLogType {
  INBOUND
  OUTBOUND
  RESERVE
  RELEASE
  ADJUSTMENT
}

model StockLog {
  id          String       @id @default(uuid()) @db.Uuid
  variantId   String       @map("variant_id") @db.Uuid
  type        StockLogType
  quantity    Int
  reason      String
  referenceId String?      @map("reference_id")
  createdAt   DateTime     @default(now()) @map("created_at")

  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([variantId])
  @@index([createdAt(sort: Desc)])
  @@map("stock_logs")
}

// ============================================
// Shipping
// ============================================

enum ShipmentStatus {
  PREPARING
  SHIPPED
  IN_TRANSIT
  DELIVERED
}

model Shipment {
  id             String         @id @default(uuid()) @db.Uuid
  orderId        String         @unique @map("order_id") @db.Uuid
  carrier        String
  trackingNumber String?        @map("tracking_number")
  status         ShipmentStatus @default(PREPARING)
  shippedAt      DateTime?      @map("shipped_at")
  deliveredAt    DateTime?      @map("delivered_at")
  createdAt      DateTime       @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id])

  @@map("shipments")
}

// ============================================
// Return & Refund
// ============================================

enum ReturnReason {
  CHANGE_MIND
  DEFECTIVE
  WRONG_ITEM
  OTHER
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  COLLECTING
  COLLECTED
  COMPLETED
  REJECTED
}

model Return {
  id           String       @id @default(uuid()) @db.Uuid
  orderId      String       @map("order_id") @db.Uuid
  orderItemId  String?      @map("order_item_id") @db.Uuid
  reason       ReturnReason
  reasonDetail String?      @map("reason_detail") @db.Text
  status       ReturnStatus @default(REQUESTED)
  refundAmount Decimal      @map("refund_amount") @db.Decimal(10, 2)
  images       String[]
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  order     Order      @relation(fields: [orderId], references: [id])
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id])

  @@map("returns")
}

// ============================================
// Coupon
// ============================================

enum CouponType {
  FIXED
  PERCENTAGE
}

model Coupon {
  id             String     @id @default(uuid()) @db.Uuid
  code           String     @unique
  name           String
  type           CouponType
  value          Decimal    @db.Decimal(10, 2)
  minOrderAmount Decimal?   @map("min_order_amount") @db.Decimal(10, 2)
  maxDiscount    Decimal?   @map("max_discount") @db.Decimal(10, 2)
  validFrom      DateTime   @map("valid_from")
  validUntil     DateTime   @map("valid_until")
  maxUsageCount  Int?       @map("max_usage_count")
  usedCount      Int        @default(0) @map("used_count")
  isActive       Boolean    @default(true) @map("is_active")
  createdAt      DateTime   @default(now()) @map("created_at")

  orders Order[]
  usages CouponUsage[]

  @@map("coupons")
}

model CouponUsage {
  id       String   @id @default(uuid()) @db.Uuid
  couponId String   @map("coupon_id") @db.Uuid
  userId   String   @map("user_id") @db.Uuid
  orderId  String   @map("order_id") @db.Uuid
  usedAt   DateTime @default(now()) @map("used_at")

  coupon Coupon @relation(fields: [couponId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([couponId, userId])
  @@map("coupon_usages")
}

// ============================================
// Promotion
// ============================================

enum PromotionType {
  CATEGORY_DISCOUNT
  PERIOD_DISCOUNT
}

model Promotion {
  id             String        @id @default(uuid()) @db.Uuid
  name           String
  type           PromotionType
  discountRate   Decimal       @map("discount_rate") @db.Decimal(5, 2)
  categoryId     String?       @map("category_id") @db.Uuid
  startDate      DateTime      @map("start_date")
  endDate        DateTime      @map("end_date")
  isActive       Boolean       @default(true) @map("is_active")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  category Category? @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([startDate, endDate])
  @@map("promotions")
}

// ============================================
// Wishlist
// ============================================

model Wishlist {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("wishlists")
}

// ============================================
// Review
// ============================================

model Review {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  orderId   String   @map("order_id") @db.Uuid
  rating    Int
  content   String   @db.Text
  images    String[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@unique([userId, orderId, productId])
  @@map("reviews")
}
